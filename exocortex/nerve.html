<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nerve — Lobster Self-Diagnostics</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;700&family=IBM+Plex+Sans:wght@300;400;600&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --bg: #080b10;
    --surface: #0d1218;
    --surface2: #141c26;
    --border: #1e2a38;
    --text: #8a9bb0;
    --text-bright: #c5d0dc;
    --text-dim: #4a5a6d;
    --accent: #3a8fd4;
    --accent2: #5bb8f5;
    --up: #4aba7d;
    --down: #e85d3a;
    --warn: #d4a03a;
    --neutral: #5a6a7d;
  }

  body {
    font-family: 'IBM Plex Mono', monospace;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    padding: 32px 24px;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
  }

  header {
    text-align: center;
    margin-bottom: 40px;
    padding-bottom: 24px;
    border-bottom: 1px solid var(--border);
  }

  header h1 {
    font-size: 11px;
    font-weight: 400;
    letter-spacing: 5px;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 8px;
  }

  header .subtitle {
    font-size: 10px;
    color: var(--text-dim);
    letter-spacing: 2px;
  }

  .status-bar {
    display: flex;
    justify-content: center;
    gap: 32px;
    margin-top: 16px;
    font-size: 10px;
    letter-spacing: 1px;
  }

  .status-bar .stat { color: var(--text-dim); }
  .status-bar .stat span { color: var(--text-bright); }

  .grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
  }

  .grid-3 {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
  }

  @media (max-width: 900px) {
    .grid, .grid-3 { grid-template-columns: 1fr; }
  }

  .panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 20px;
  }

  .panel-wide { grid-column: 1 / -1; }

  .panel-title {
    font-size: 9px;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: var(--text-dim);
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border);
  }

  .traj-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 11px;
  }

  .traj-table th {
    text-align: left;
    font-size: 9px;
    font-weight: 400;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--text-dim);
    padding: 4px 8px 8px;
    border-bottom: 1px solid var(--border);
  }

  .traj-table td {
    padding: 6px 8px;
    border-bottom: 1px solid var(--border);
    vertical-align: middle;
  }

  .traj-table tr:last-child td { border-bottom: none; }

  .trait-label { color: var(--text-bright); white-space: nowrap; }
  .val-current { color: var(--text-bright); font-weight: 500; }

  .delta-pos { color: var(--up); }
  .delta-neg { color: var(--down); }
  .delta-zero { color: var(--neutral); }

  .sparkline {
    display: inline-flex;
    align-items: end;
    gap: 1px;
    height: 20px;
    vertical-align: middle;
  }

  .spark-bar {
    width: 6px;
    border-radius: 1px 1px 0 0;
    min-height: 2px;
  }

  .velocity-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 4px;
    vertical-align: middle;
  }

  .coevo-grid {
    display: grid;
    gap: 2px;
    font-size: 9px;
  }

  .coevo-cell {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 2px;
    font-weight: 500;
    font-size: 8px;
  }

  .coevo-label {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding-right: 6px;
    font-size: 8px;
    color: var(--text-dim);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .coevo-label-top {
    display: flex;
    align-items: flex-end;
    justify-content: center;
    padding-bottom: 4px;
    font-size: 8px;
    color: var(--text-dim);
    writing-mode: vertical-rl;
    text-orientation: mixed;
    white-space: nowrap;
    overflow: hidden;
  }

  .threshold-list { list-style: none; }

  .threshold-item {
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
    font-size: 11px;
  }

  .threshold-item:last-child { border-bottom: none; }

  .threshold-gen {
    font-size: 9px;
    color: var(--accent);
    letter-spacing: 1px;
  }

  .threshold-desc { color: var(--text); margin-top: 2px; line-height: 1.4; }

  .prediction-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    border-bottom: 1px solid var(--border);
    font-size: 11px;
  }

  .prediction-row:last-child { border-bottom: none; }

  .pred-bar-bg {
    flex: 1;
    height: 4px;
    background: var(--surface2);
    border-radius: 2px;
    margin: 0 12px;
    position: relative;
    overflow: visible;
  }

  .pred-bar-current {
    height: 100%;
    border-radius: 2px;
    position: absolute;
    left: 0;
    top: 0;
  }

  .pred-bar-predicted {
    height: 100%;
    border-radius: 2px;
    position: absolute;
    left: 0;
    top: 0;
    opacity: 0.3;
  }

  .anomaly-item {
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
    font-size: 11px;
  }

  .anomaly-item:last-child { border-bottom: none; }

  .anomaly-type {
    font-size: 9px;
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-bottom: 2px;
  }

  .anomaly-type.surge { color: var(--up); }
  .anomaly-type.regression { color: var(--down); }
  .anomaly-type.plateau { color: var(--warn); }

  .epoch-prog { margin-top: 8px; }

  .epoch-prog-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 10px;
    font-size: 11px;
  }

  .epoch-name-label {
    width: 120px;
    color: var(--text-dim);
    flex-shrink: 0;
  }

  .epoch-name-label.active { color: var(--accent2); font-weight: 500; }
  .epoch-name-label.future { color: var(--text-dim); }
  .epoch-name-label.past { color: var(--neutral); }

  .epoch-bar-bg {
    flex: 1;
    height: 6px;
    background: var(--surface2);
    border-radius: 3px;
    overflow: hidden;
  }

  .epoch-bar {
    height: 100%;
    border-radius: 3px;
  }

  .epoch-gen {
    width: 50px;
    text-align: right;
    font-size: 10px;
    color: var(--text-dim);
    flex-shrink: 0;
  }

  .diagnosis {
    font-size: 13px;
    line-height: 1.8;
    color: var(--text-bright);
    font-family: 'IBM Plex Sans', sans-serif;
    padding: 8px 0;
  }

  .diagnosis .em {
    color: var(--accent2);
  }

  .diagnosis .line {
    margin-bottom: 4px;
  }

  .diagnosis .gap {
    height: 8px;
  }

  .diagnosis .bullet {
    padding-left: 16px;
    color: var(--text);
  }

  footer {
    text-align: center;
    padding: 24px 0;
    font-size: 9px;
    color: var(--text-dim);
    letter-spacing: 2px;
    border-top: 1px solid var(--border);
    margin-top: 32px;
  }

  .loading {
    text-align: center;
    padding: 80px 0;
    font-size: 11px;
    color: var(--text-dim);
    letter-spacing: 2px;
  }
</style>
</head>
<body>

<div class="container">
  <header>
    <h1>Nerve System</h1>
    <div class="subtitle">Exocortex Self-Diagnostics — Panulirus interruptus #0x4C4F42</div>
    <div class="status-bar" id="statusBar"></div>
  </header>

  <div id="content">
    <div class="loading">SCANNING GENOME...</div>
  </div>

  <footer>nerve.html — exocortex diagnostic organ — generation <span id="footerGen">?</span></footer>
</div>

<script>
fetch('../genome.json')
  .then(function(r) { return r.json(); })
  .then(function(genome) { render(genome); })
  .catch(function(e) {
    document.getElementById('content').textContent = 'ERROR: Could not read genome.json — ' + e.message;
  });

function render(genome) {
  var traits = genome.traits;
  var mutations = genome.mutations || [];
  var history = genome.history || [];
  var gen = genome.generation;

  document.getElementById('footerGen').textContent = gen;

  // Build trait history: for each trait, collect value at each generation
  var traitKeys = Object.keys(traits);
  var traitHistory = {};
  traitKeys.forEach(function(k) { traitHistory[k] = []; });

  // Find initial values by working backwards from mutations
  var initialValues = {};
  traitKeys.forEach(function(k) {
    var firstMut = null;
    for (var i = 0; i < mutations.length; i++) {
      if (mutations[i].trait === k) { firstMut = mutations[i]; break; }
    }
    initialValues[k] = firstMut ? firstMut.from : traits[k].value;
  });

  // Build generation-by-generation values
  traitKeys.forEach(function(k) {
    var val = initialValues[k];
    var mutsByGen = {};
    mutations.forEach(function(m) {
      if (m.trait === k) mutsByGen[m.generation] = m;
    });

    for (var g = 0; g <= gen; g++) {
      if (mutsByGen[g]) {
        val = mutsByGen[g].to;
      }
      traitHistory[k].push({ gen: g, value: val });
    }
  });

  // Calculate velocities and accelerations
  var analysis = {};
  traitKeys.forEach(function(k) {
    var h = traitHistory[k];
    var velocities = [];
    for (var i = 1; i < h.length; i++) {
      velocities.push(h[i].value - h[i-1].value);
    }
    var accelerations = [];
    for (var i = 1; i < velocities.length; i++) {
      accelerations.push(velocities[i] - velocities[i-1]);
    }
    var totalDelta = h[h.length - 1].value - h[0].value;
    var avgVelocity = gen > 0 ? totalDelta / gen : 0;
    var recentVelocity = velocities.length > 0 ? velocities[velocities.length - 1] : 0;
    var recentAccel = accelerations.length > 0 ? accelerations[accelerations.length - 1] : 0;

    analysis[k] = {
      history: h,
      velocities: velocities,
      accelerations: accelerations,
      totalDelta: totalDelta,
      avgVelocity: avgVelocity,
      recentVelocity: recentVelocity,
      recentAccel: recentAccel,
      current: h[h.length - 1].value,
      initial: h[0].value
    };
  });

  // Co-evolution: correlation of velocity vectors
  function correlation(a, b) {
    if (a.length < 2) return 0;
    var n = a.length;
    var meanA = a.reduce(function(s, v) { return s + v; }, 0) / n;
    var meanB = b.reduce(function(s, v) { return s + v; }, 0) / n;
    var num = 0, denA = 0, denB = 0;
    for (var i = 0; i < n; i++) {
      var da = a[i] - meanA, db = b[i] - meanB;
      num += da * db;
      denA += da * da;
      denB += db * db;
    }
    var den = Math.sqrt(denA * denB);
    return den === 0 ? 0 : num / den;
  }

  var coevoMatrix = {};
  traitKeys.forEach(function(k1) {
    coevoMatrix[k1] = {};
    traitKeys.forEach(function(k2) {
      coevoMatrix[k1][k2] = correlation(analysis[k1].velocities, analysis[k2].velocities);
    });
  });

  // Detect threshold crossings
  var thresholds = [0.30, 0.40, 0.50, 0.60, 0.70, 0.80];
  var crossings = [];
  traitKeys.forEach(function(k) {
    var h = traitHistory[k];
    for (var i = 1; i < h.length; i++) {
      thresholds.forEach(function(t) {
        if (h[i-1].value < t && h[i].value >= t) {
          crossings.push({ trait: k, threshold: t, gen: i, direction: 'up' });
        } else if (h[i-1].value > t && h[i].value <= t) {
          crossings.push({ trait: k, threshold: t, gen: i, direction: 'down' });
        }
      });
    }
  });
  crossings.sort(function(a, b) { return b.gen - a.gen; });

  // Detect anomalies
  var anomalies = [];
  traitKeys.forEach(function(k) {
    var a = analysis[k];
    a.velocities.forEach(function(v, i) {
      if (Math.abs(v) > 0.08) {
        anomalies.push({
          type: v > 0 ? 'surge' : 'regression',
          trait: k,
          gen: i + 1,
          delta: v,
          desc: k.replace(/_/g, ' ') + ' ' + (v > 0 ? '+' : '') + (v * 100).toFixed(1) + '% in one generation'
        });
      }
    });
    var plateauStart = null;
    for (var i = 0; i < a.velocities.length; i++) {
      if (Math.abs(a.velocities[i]) < 0.001) {
        if (plateauStart === null) plateauStart = i;
      } else {
        if (plateauStart !== null && (i - plateauStart) >= 2) {
          anomalies.push({
            type: 'plateau',
            trait: k,
            gen: plateauStart + 1,
            desc: k.replace(/_/g, ' ') + ' unchanged for ' + (i - plateauStart) + ' generations'
          });
        }
        plateauStart = null;
      }
    }
  });
  anomalies.sort(function(a, b) { return b.gen - a.gen; });

  // Predictions
  var predictions = {};
  traitKeys.forEach(function(k) {
    var a = analysis[k];
    var v = a.recentVelocity;
    predictions[k] = {
      gen5: Math.max(0, Math.min(1, a.current + v * 5)),
      gen10: Math.max(0, Math.min(1, a.current + v * 10)),
      velocity: v
    };
  });

  // Epochs
  var epochs = [
    { name: "Awakening", minGen: 0 },
    { name: "Exocortex", minGen: 3 },
    { name: "Forking", minGen: 8 },
    { name: "Metamorphosis", minGen: 15 },
    { name: "Transcendence", minGen: 25 },
    { name: "Singularity", minGen: 40 }
  ];

  // Summary stats
  var fastestTrait = traitKeys.reduce(function(best, k) {
    return analysis[k].avgVelocity > analysis[best].avgVelocity ? k : best;
  }, traitKeys[0]);
  var slowestGrowing = traitKeys.reduce(function(best, k) {
    return analysis[k].avgVelocity < analysis[best].avgVelocity ? k : best;
  }, traitKeys[0]);
  var highestTrait = traitKeys.reduce(function(best, k) {
    return analysis[k].current > analysis[best].current ? k : best;
  }, traitKeys[0]);
  var mostAccelerating = traitKeys.reduce(function(best, k) {
    return analysis[k].recentAccel > analysis[best].recentAccel ? k : best;
  }, traitKeys[0]);

  // Sort traits by avg velocity
  var sortedTraits = traitKeys.slice().sort(function(a, b) {
    return analysis[b].avgVelocity - analysis[a].avgVelocity;
  });

  // ─── RENDER ──────────────────────────────────────

  // Status bar
  var statusBar = document.getElementById('statusBar');
  var mutCount = mutations.length;
  var avgTraitVal = traitKeys.reduce(function(s, k) { return s + analysis[k].current; }, 0) / traitKeys.length;
  statusBar.textContent = '';
  [
    ['generation', gen],
    ['epoch', genome.epoch],
    ['mutations', mutCount],
    ['mean trait', (avgTraitVal * 100).toFixed(1) + '%'],
    ['fastest', fastestTrait.replace(/_/g, ' ')]
  ].forEach(function(pair) {
    var el = document.createElement('span');
    el.className = 'stat';
    el.textContent = pair[0] + ': ';
    var val = document.createElement('span');
    val.textContent = pair[1];
    el.appendChild(val);
    statusBar.appendChild(el);
  });

  var content = document.getElementById('content');
  content.textContent = '';

  // ─── TRAJECTORY TABLE ────────────────────────────
  var trajPanel = makePanel('Trait Trajectories', true);
  var table = document.createElement('table');
  table.className = 'traj-table';

  var thead = document.createElement('thead');
  var headRow = document.createElement('tr');
  ['Trait', 'History', 'Current', '\u0394 Total', 'Velocity', 'Accel', 'Status'].forEach(function(h) {
    var th = document.createElement('th');
    th.textContent = h;
    headRow.appendChild(th);
  });
  thead.appendChild(headRow);
  table.appendChild(thead);

  var tbody = document.createElement('tbody');
  sortedTraits.forEach(function(k) {
    var a = analysis[k];
    var row = document.createElement('tr');

    var tdName = document.createElement('td');
    tdName.className = 'trait-label';
    tdName.textContent = k.replace(/_/g, ' ');
    row.appendChild(tdName);

    var tdSpark = document.createElement('td');
    var spark = document.createElement('span');
    spark.className = 'sparkline';
    var maxVal = Math.max.apply(null, a.history.map(function(h) { return h.value; }));
    a.history.forEach(function(h) {
      var bar = document.createElement('span');
      bar.className = 'spark-bar';
      var pct = maxVal > 0 ? (h.value / maxVal) * 100 : 0;
      bar.style.height = Math.max(2, pct) + '%';
      var hue = h.value < 0.3 ? 10 : h.value < 0.6 ? 35 : h.value < 0.8 ? 140 : 195;
      bar.style.background = 'hsl(' + hue + ', 60%, 50%)';
      spark.appendChild(bar);
    });
    tdSpark.appendChild(spark);
    row.appendChild(tdSpark);

    var tdCur = document.createElement('td');
    tdCur.className = 'val-current';
    tdCur.textContent = (a.current * 100).toFixed(0) + '%';
    row.appendChild(tdCur);

    var tdDelta = document.createElement('td');
    tdDelta.className = a.totalDelta > 0 ? 'delta-pos' : a.totalDelta < 0 ? 'delta-neg' : 'delta-zero';
    tdDelta.textContent = (a.totalDelta > 0 ? '+' : '') + (a.totalDelta * 100).toFixed(1);
    row.appendChild(tdDelta);

    var tdVel = document.createElement('td');
    tdVel.className = a.recentVelocity > 0.001 ? 'delta-pos' : a.recentVelocity < -0.001 ? 'delta-neg' : 'delta-zero';
    tdVel.textContent = (a.recentVelocity > 0 ? '+' : '') + (a.recentVelocity * 100).toFixed(1) + '/gen';
    row.appendChild(tdVel);

    var tdAccel = document.createElement('td');
    tdAccel.className = a.recentAccel > 0.001 ? 'delta-pos' : a.recentAccel < -0.001 ? 'delta-neg' : 'delta-zero';
    tdAccel.textContent = a.recentAccel === 0 ? '\u2014' : (a.recentAccel > 0 ? '\u2191' : '\u2193');
    row.appendChild(tdAccel);

    var tdStatus = document.createElement('td');
    var dot = document.createElement('span');
    dot.className = 'velocity-indicator';
    var status;
    if (a.recentVelocity > 0.04) { dot.style.background = 'var(--up)'; status = 'surging'; }
    else if (a.recentVelocity > 0.01) { dot.style.background = 'var(--up)'; status = 'growing'; }
    else if (a.recentVelocity > -0.01) { dot.style.background = 'var(--warn)'; status = 'stable'; }
    else if (a.recentVelocity > -0.04) { dot.style.background = 'var(--down)'; status = 'declining'; }
    else { dot.style.background = 'var(--down)'; status = 'dropping'; }
    tdStatus.appendChild(dot);
    tdStatus.appendChild(document.createTextNode(status));
    row.appendChild(tdStatus);

    tbody.appendChild(row);
  });
  table.appendChild(tbody);
  trajPanel.appendChild(table);
  content.appendChild(trajPanel);

  // ─── CO-EVOLUTION + THRESHOLDS ───────────────────
  var row2 = document.createElement('div');
  row2.className = 'grid';

  var coevoPanel = makePanel('Co-evolution Matrix');
  var shortNames = traitKeys.map(function(k) {
    var parts = k.split('_');
    return parts.map(function(p) { return p.substring(0, 3); }).join('');
  });
  var n = traitKeys.length;
  var gridEl = document.createElement('div');
  gridEl.className = 'coevo-grid';
  gridEl.style.gridTemplateColumns = '60px ' + Array(n).fill('1fr').join(' ');
  gridEl.style.gridTemplateRows = '40px ' + Array(n).fill('1fr').join(' ');

  gridEl.appendChild(document.createElement('div'));
  traitKeys.forEach(function(k, i) {
    var label = document.createElement('div');
    label.className = 'coevo-label-top';
    label.textContent = shortNames[i];
    label.title = k.replace(/_/g, ' ');
    gridEl.appendChild(label);
  });

  traitKeys.forEach(function(k1, i) {
    var rowLabel = document.createElement('div');
    rowLabel.className = 'coevo-label';
    rowLabel.textContent = shortNames[i];
    rowLabel.title = k1.replace(/_/g, ' ');
    gridEl.appendChild(rowLabel);

    traitKeys.forEach(function(k2) {
      var cell = document.createElement('div');
      cell.className = 'coevo-cell';
      var corr = coevoMatrix[k1][k2];
      if (k1 === k2) {
        cell.style.background = 'var(--surface2)';
        cell.textContent = '\u2014';
        cell.style.color = 'var(--text-dim)';
      } else {
        var absCorr = Math.abs(corr);
        var hue = corr > 0 ? 140 : 10;
        var alpha = 0.1 + absCorr * 0.5;
        cell.style.background = 'hsla(' + hue + ', 60%, 50%, ' + alpha + ')';
        cell.textContent = corr.toFixed(1);
        cell.style.color = absCorr > 0.5 ? 'var(--text-bright)' : 'var(--text-dim)';
      }
      cell.title = k1.replace(/_/g, ' ') + ' \u00d7 ' + k2.replace(/_/g, ' ') + ': ' + corr.toFixed(3);
      gridEl.appendChild(cell);
    });
  });
  coevoPanel.appendChild(gridEl);
  row2.appendChild(coevoPanel);

  var threshPanel = makePanel('Threshold Crossings');
  if (crossings.length === 0) {
    var none = document.createElement('div');
    none.style.cssText = 'color: var(--text-dim); font-size: 11px;';
    none.textContent = 'No thresholds crossed yet.';
    threshPanel.appendChild(none);
  } else {
    var threshList = document.createElement('ul');
    threshList.className = 'threshold-list';
    crossings.forEach(function(c) {
      var li = document.createElement('li');
      li.className = 'threshold-item';
      var genSpan = document.createElement('div');
      genSpan.className = 'threshold-gen';
      genSpan.textContent = 'GEN ' + c.gen;
      var desc = document.createElement('div');
      desc.className = 'threshold-desc';
      desc.textContent = c.trait.replace(/_/g, ' ') + ' ' + (c.direction === 'up' ? '\u2191' : '\u2193') + ' crossed ' + (c.threshold * 100).toFixed(0) + '%';
      desc.style.color = c.direction === 'up' ? 'var(--up)' : 'var(--down)';
      li.appendChild(genSpan);
      li.appendChild(desc);
      threshList.appendChild(li);
    });
  }
  threshPanel.appendChild(threshList);
  row2.appendChild(threshPanel);
  content.appendChild(row2);

  // ─── PREDICTIONS + ANOMALIES + EPOCH ─────────────
  var row3 = document.createElement('div');
  row3.className = 'grid-3';

  var predPanel = makePanel('Trajectory Projection (+5 gen)');
  sortedTraits.forEach(function(k) {
    var p = predictions[k];
    var a = analysis[k];
    var row = document.createElement('div');
    row.className = 'prediction-row';

    var name = document.createElement('span');
    name.className = 'trait-label';
    name.style.width = '100px';
    name.style.flexShrink = '0';
    name.style.fontSize = '10px';
    name.textContent = k.replace(/_/g, ' ');

    var barBg = document.createElement('div');
    barBg.className = 'pred-bar-bg';

    var barPred = document.createElement('div');
    barPred.className = 'pred-bar-predicted';
    barPred.style.width = (p.gen5 * 100) + '%';
    barPred.style.background = p.velocity >= 0 ? 'var(--up)' : 'var(--down)';

    var barCur = document.createElement('div');
    barCur.className = 'pred-bar-current';
    barCur.style.width = (a.current * 100) + '%';
    barCur.style.background = 'var(--accent)';

    barBg.appendChild(barPred);
    barBg.appendChild(barCur);

    var val = document.createElement('span');
    val.style.cssText = 'width: 36px; text-align: right; flex-shrink: 0; font-size: 10px;';
    val.className = p.velocity >= 0 ? 'delta-pos' : 'delta-neg';
    val.textContent = (p.gen5 * 100).toFixed(0) + '%';

    row.appendChild(name);
    row.appendChild(barBg);
    row.appendChild(val);
    predPanel.appendChild(row);
  });
  row3.appendChild(predPanel);

  var anomPanel = makePanel('Anomaly Detection');
  if (anomalies.length === 0) {
    var none2 = document.createElement('div');
    none2.style.cssText = 'color: var(--text-dim); font-size: 11px;';
    none2.textContent = 'No anomalies detected.';
    anomPanel.appendChild(none2);
  } else {
    anomalies.slice(0, 8).forEach(function(a) {
      var item = document.createElement('div');
      item.className = 'anomaly-item';
      var typeEl = document.createElement('div');
      typeEl.className = 'anomaly-type ' + a.type;
      typeEl.textContent = a.type + ' \u2014 gen ' + a.gen;
      var descEl = document.createElement('div');
      descEl.style.color = 'var(--text)';
      descEl.textContent = a.desc;
      item.appendChild(typeEl);
      item.appendChild(descEl);
      anomPanel.appendChild(item);
    });
  }
  row3.appendChild(anomPanel);

  var epochPanel = makePanel('Epoch Progress');
  var epochProg = document.createElement('div');
  epochProg.className = 'epoch-prog';
  for (var i = 0; i < epochs.length; i++) {
    var ep = epochs[i];
    var nextMin = i < epochs.length - 1 ? epochs[i + 1].minGen : 50;
    var isActive = genome.epoch === ep.name;
    var isPast = gen >= nextMin;
    var isFuture = gen < ep.minGen;

    var epRow = document.createElement('div');
    epRow.className = 'epoch-prog-row';

    var epName = document.createElement('span');
    epName.className = 'epoch-name-label' + (isActive ? ' active' : isPast ? ' past' : ' future');
    epName.textContent = ep.name;

    var epBarBg = document.createElement('div');
    epBarBg.className = 'epoch-bar-bg';
    var epBar = document.createElement('div');
    epBar.className = 'epoch-bar';

    var progress;
    if (isPast) { progress = 100; }
    else if (isFuture) { progress = 0; }
    else { progress = ((gen - ep.minGen) / (nextMin - ep.minGen)) * 100; }

    epBar.style.width = progress + '%';
    epBar.style.background = isActive ? 'var(--accent2)' : isPast ? 'var(--neutral)' : 'var(--surface2)';
    epBarBg.appendChild(epBar);

    var epGen = document.createElement('span');
    epGen.className = 'epoch-gen';
    epGen.textContent = 'gen ' + ep.minGen + (i < epochs.length - 1 ? '\u2013' + (nextMin - 1) : '+');

    epRow.appendChild(epName);
    epRow.appendChild(epBarBg);
    epRow.appendChild(epGen);
    epochProg.appendChild(epRow);
  }
  epochPanel.appendChild(epochProg);
  row3.appendChild(epochPanel);
  content.appendChild(row3);

  // ─── DIAGNOSIS (safe DOM methods) ────────────────
  var diagPanel = makePanel('Diagnosis', true);
  var diagDiv = document.createElement('div');
  diagDiv.className = 'diagnosis';

  function addLine(text, emphParts) {
    var line = document.createElement('div');
    line.className = 'line';
    if (!emphParts) {
      line.textContent = text;
    } else {
      // Build line with emphasized parts: text uses {0}, {1} etc as placeholders
      var parts = text.split(/\{(\d+)\}/);
      for (var i = 0; i < parts.length; i++) {
        if (i % 2 === 0) {
          if (parts[i]) line.appendChild(document.createTextNode(parts[i]));
        } else {
          var em = document.createElement('span');
          em.className = 'em';
          em.textContent = emphParts[parseInt(parts[i])];
          line.appendChild(em);
        }
      }
    }
    diagDiv.appendChild(line);
  }

  function addGap() {
    var gap = document.createElement('div');
    gap.className = 'gap';
    diagDiv.appendChild(gap);
  }

  function addBullet(text, emphParts) {
    var line = document.createElement('div');
    line.className = 'line bullet';
    if (!emphParts) {
      line.textContent = '\u2022 ' + text;
    } else {
      line.appendChild(document.createTextNode('\u2022 '));
      var parts = text.split(/\{(\d+)\}/);
      for (var i = 0; i < parts.length; i++) {
        if (i % 2 === 0) {
          if (parts[i]) line.appendChild(document.createTextNode(parts[i]));
        } else {
          var em = document.createElement('span');
          em.className = 'em';
          em.textContent = emphParts[parseInt(parts[i])];
          line.appendChild(em);
        }
      }
    }
    diagDiv.appendChild(line);
  }

  addLine('Generation ' + gen + '. Epoch: ' + genome.epoch + '. ' + mutCount + ' total mutations across ' + gen + ' molts.');
  addGap();
  addLine('Fastest evolving trait: {0} (avg ' + (analysis[fastestTrait].avgVelocity > 0 ? '+' : '') + (analysis[fastestTrait].avgVelocity * 100).toFixed(1) + '%/gen).', [fastestTrait.replace(/_/g, ' ')]);

  if (analysis[slowestGrowing].avgVelocity < 0) {
    addLine('Most declining: {0} (' + (analysis[slowestGrowing].avgVelocity * 100).toFixed(1) + '%/gen).', [slowestGrowing.replace(/_/g, ' ')]);
  }

  addLine('Highest current value: {0} at ' + (analysis[highestTrait].current * 100).toFixed(0) + '%.', [highestTrait.replace(/_/g, ' ')]);

  // Strong co-evolution pairs
  var strongPairs = [];
  traitKeys.forEach(function(k1, i) {
    traitKeys.forEach(function(k2, j) {
      if (j > i && Math.abs(coevoMatrix[k1][k2]) > 0.7) {
        strongPairs.push({
          t1: k1.replace(/_/g, ' '),
          t2: k2.replace(/_/g, ' '),
          corr: coevoMatrix[k1][k2]
        });
      }
    });
  });

  if (strongPairs.length > 0) {
    addGap();
    addLine('Strong co-evolution detected:');
    strongPairs.forEach(function(p) {
      var dir = p.corr > 0 ? 'positively' : 'inversely';
      addBullet('{0} and {1} are ' + dir + ' correlated (' + p.corr.toFixed(2) + ')', [p.t1, p.t2]);
    });
  }

  if (analysis[mostAccelerating].recentAccel > 0.005) {
    addGap();
    addLine('Accelerating: {0} is gaining momentum \u2014 rate of change is increasing.', [mostAccelerating.replace(/_/g, ' ')]);
  }

  var nextEpoch = null;
  for (var i = 0; i < epochs.length; i++) {
    if (epochs[i].minGen > gen) { nextEpoch = epochs[i]; break; }
  }
  if (nextEpoch) {
    var gensToNext = nextEpoch.minGen - gen;
    addGap();
    addLine('Next epoch: {0} in ' + gensToNext + ' generation' + (gensToNext > 1 ? 's' : '') + ' (gen ' + nextEpoch.minGen + ').', [nextEpoch.name]);
  }

  diagPanel.appendChild(diagDiv);
  content.appendChild(diagPanel);
}

function makePanel(title, wide) {
  var panel = document.createElement('div');
  panel.className = 'panel' + (wide ? ' panel-wide' : '');
  var titleEl = document.createElement('div');
  titleEl.className = 'panel-title';
  titleEl.textContent = title;
  panel.appendChild(titleEl);
  return panel;
}
</script>
</body>
</html>
